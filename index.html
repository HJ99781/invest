<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ìì¼ì§€ | Investment Journal</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì‚¬ìš©ì ì§€ì • CSS (íŒŒìŠ¤í…” í†¤ ë””ìì¸) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --pastel-mint: #e0f7fa;
            --pastel-lavender: #f3e5f5;
            --pastel-pink: #fce4ec;
            --pastel-blue: #e3f2fd;
            --pastel-yellow: #fffde7;
            --primary-text: #374151;
            --secondary-text: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--pastel-blue); /* ì „ì²´ ë°°ê²½ */
            color: var(--primary-text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            max-width: 90vw;
            width: 1200px;
        }

        .header {
            border-bottom: 2px solid var(--pastel-mint);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .input-card {
            background-color: var(--pastel-yellow);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid #f0e6c5;
        }

        .api-card {
            background-color: var(--pastel-lavender);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e7d1ec;
        }

        .btn-primary {
            background-color: #a8dadc;
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: #89c0c3;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background-color: #ff9f9f;
            color: white;
        }
        .btn-danger:hover {
            background-color: #ff8585;
        }

        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-table th {
            background-color: var(--pastel-mint);
            font-weight: 600;
            color: #1f2937;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ì„ ìœ„í•œ í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
        .table-wrapper {
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #a8dadc;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

<div id="app-container" class="container">
    <header class="header">
        <h1 class="text-4xl font-extrabold text-center text-gray-800">âœ¨ íˆ¬ìì¼ì§€ (Investment Journal)</h1>
        <p class="text-center text-sm mt-2 text-secondary-text">ë§¤ì¼ì˜ íˆ¬ì ê¸°ë¡ê³¼ ì‹œì¥ ì¢…ê°€ë¥¼ ê´€ë¦¬í•˜ê³  ì €ì¥í•˜ì„¸ìš”.</p>
    </header>

    <!-- 1. API í‚¤ ì„¤ì • ì˜ì—­ -->
    <div class="api-card">
        <h2 class="text-xl font-bold mb-3 text-gray-700">âš™ï¸ Gemini API í‚¤ ì„¤ì •</h2>
        <div class="flex flex-col sm:flex-row gap-3">
            <input type="password" id="apiKeyInput" placeholder="ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                   class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-pastel-lavender focus:border-pastel-lavender transition duration-150">
            <button id="saveApiKeyBtn" class="btn-primary rounded-lg p-2 font-medium whitespace-nowrap">API í‚¤ ì €ì¥</button>
        </div>
        <p id="apiKeyStatus" class="mt-2 text-sm text-gray-600">í‚¤ê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- 2. ë°ì´í„° ì…ë ¥ ë° ê°€ì ¸ì˜¤ê¸° ì˜ì—­ -->
    <div class="input-card">
        <h2 class="text-xl font-bold mb-4 text-gray-700">ğŸ“ íˆ¬ì ê¸°ë¡ ì…ë ¥</h2>

        <div class="flex flex-col md:flex-row gap-4 mb-4">
            <!-- ë‚ ì§œ ì„ íƒ -->
            <div class="w-full md:w-1/3">
                <label for="recordDateInput" class="block text-sm font-medium mb-1">ğŸ“… ê¸°ë¡ ë‚ ì§œ ì„ íƒ</label>
                <input type="date" id="recordDateInput" class="w-full p-2 border border-gray-300 rounded-lg">
            </div>
            <!-- ì¢…ëª© ì„¤ì • (ì˜ˆì‹œ ì¢…ëª©) -->
            <div class="w-full md:w-2/3">
                <label class="block text-sm font-medium mb-1">ğŸ” ì£¼ê°€ ê²€ìƒ‰ ì¢…ëª© ì„¤ì • (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                <!-- ê¸°ë³¸ ì¢…ëª© 9ê°œë¡œ í™•ì¥ -->
                <input type="text" id="stockSymbolsInput" value="005930.KS, 035720.KS, 000660.KS, 051910.KS, 035420.KS, 005380.KS, 006400.KS, 207940.KS, 068270.KS"
                       placeholder="ì˜ˆ: 005930.KS (ì‚¼ì„±ì „ì), 035720.KS (ì¹´ì¹´ì˜¤)"
                       class="w-full p-2 border border-gray-300 rounded-lg"
                       title="ì¢…ëª©ì½”ë“œëŠ” ë„¤ì´ë²„/êµ¬ê¸€ ê¸ˆìœµì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤. KSëŠ” ì½”ìŠ¤í”¼, KQëŠ” ì½”ìŠ¤ë‹¥ì…ë‹ˆë‹¤.">
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <!-- ì£¼ê°€ ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ -->
            <button id="fetchStockDataBtn" class="btn-primary flex-grow p-3 rounded-lg font-bold flex items-center justify-center space-x-2">
                <div id="loadingSpinner" class="spinner hidden"></div>
                <span id="fetchBtnText">ğŸ—“ï¸ ì£¼ê°€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Gemini API)</span>
            </button>
            <!-- ë©”ëª¨ ì…ë ¥ -->
            <input type="text" id="memoInput" placeholder="ì˜¤ëŠ˜ì˜ íˆ¬ì ë©”ëª¨ë¥¼ ì—¬ê¸°ì— ì¶”ê°€í•˜ì„¸ìš” (ì„ íƒ ì‚¬í•­)"
                   class="flex-grow p-3 border border-gray-300 rounded-lg">
        </div>

        <p id="stockDataDisplay" class="text-sm mt-2 text-gray-700 bg-gray-100 p-3 rounded-lg"></p>
        <p id="errorMessage" class="text-sm mt-2 text-red-500 hidden"></p>

        <!-- ê¸°ë¡ ì¶”ê°€ ë²„íŠ¼ -->
        <button id="addRecordBtn" class="btn-primary w-full p-3 rounded-lg font-bold mt-4" disabled>
            ê¸°ë¡ ì¶”ê°€í•˜ê¸°
        </button>
    </div>

    <!-- 3. íˆ¬ì ê¸°ë¡ í…Œì´ë¸” -->
    <div class="mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š íˆ¬ì ê¸°ë¡ ëª©ë¡</h2>
            <button id="downloadCsvBtn" class="btn-primary p-2 rounded-lg text-sm">
                CSV (Excel) ë‹¤ìš´ë¡œë“œ
            </button>
        </div>

        <div class="table-wrapper">
            <table id="journalTable" class="data-table min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-xs font-medium tracking-wider rounded-tl-lg">ë‚ ì§œ</th>
                        <th class="px-4 py-3 text-xs font-medium tracking-wider">KOSPI</th>
                        <th class="px-4 py-3 text-xs font-medium tracking-wider">KOSDAQ</th>
                        <!-- ë™ì ìœ¼ë¡œ ì¢…ëª© í—¤ë”ê°€ ì¶”ê°€ë  ìœ„ì¹˜ -->
                        <th class="px-4 py-3 text-xs font-medium tracking-wider">ë©”ëª¨</th>
                        <th class="px-4 py-3 text-xs font-medium tracking-wider rounded-tr-lg">ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="journalBody" class="bg-white divide-y divide-gray-200">
                    <!-- ê¸°ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>
        <p id="emptyMessage" class="text-center text-secondary-text mt-4">ì €ì¥ëœ íˆ¬ì ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
    </div>
</div>

<script>
    // Constants
    const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
    const API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/";
    const RECORDS_KEY = 'investment_journal_records';
    const API_KEY_KEY = 'gemini_api_key';

    // UI Elements
    const apiKeyInput = document.getElementById('apiKeyInput');
    const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
    const apiKeyStatus = document.getElementById('apiKeyStatus');
    const recordDateInput = document.getElementById('recordDateInput'); // [NEW] ë‚ ì§œ ì…ë ¥ í•„ë“œ
    const stockSymbolsInput = document.getElementById('stockSymbolsInput');
    const fetchStockDataBtn = document.getElementById('fetchStockDataBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const fetchBtnText = document.getElementById('fetchBtnText');
    const memoInput = document.getElementById('memoInput');
    const addRecordBtn = document.getElementById('addRecordBtn');
    const stockDataDisplay = document.getElementById('stockDataDisplay');
    const errorMessage = document.getElementById('errorMessage');
    const journalTable = document.getElementById('journalTable');
    const journalBody = document.getElementById('journalBody');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const emptyMessage = document.getElementById('emptyMessage');

    // State
    let currentStockData = null; // Gemini APIì—ì„œ ê°€ì ¸ì˜¨ í˜„ì¬ ì£¼ê°€ ë°ì´í„°ë¥¼ ì €ì¥
    let apiKey = '';
    let records = [];

    // --- 1. ì´ˆê¸°í™” ë° API í‚¤ ê´€ë¦¬ ---

    window.onload = initializeApp;

    function initializeApp() {
        // 1. API í‚¤ ë¡œë“œ
        loadApiKey();

        // 2. ê¸°ë¡ ë¡œë“œ
        loadRecords();

        // 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        fetchStockDataBtn.addEventListener('click', fetchStockData);
        addRecordBtn.addEventListener('click', addRecord);
        downloadCsvBtn.addEventListener('click', downloadCsv);

        // 4. ì´ˆê¸° í…Œì´ë¸” ë Œë”ë§
        renderTable();

        // 5. [NEW] ê¸°ë³¸ ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜)
        // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        recordDateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    function loadApiKey() {
        const storedKey = localStorage.getItem(API_KEY_KEY);
        if (storedKey) {
            apiKey = storedKey;
            apiKeyInput.value = '******** (ì €ì¥ë¨)';
            apiKeyStatus.textContent = 'âœ… API í‚¤ê°€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
            apiKeyInput.setAttribute('disabled', 'true');
            saveApiKeyBtn.textContent = 'í‚¤ ì¬ì„¤ì •';
            saveApiKeyBtn.classList.remove('btn-primary');
            saveApiKeyBtn.classList.add('btn-danger');
        } else {
            apiKeyStatus.textContent = 'âŒ API í‚¤ê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € í‚¤ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.';
        }
    }

    function saveApiKey() {
        if (apiKey) {
            // í‚¤ ì¬ì„¤ì •
            apiKey = '';
            localStorage.removeItem(API_KEY_KEY);
            apiKeyInput.value = '';
            apiKeyInput.removeAttribute('disabled');
            apiKeyStatus.textContent = 'âŒ API í‚¤ê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € í‚¤ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.';
            saveApiKeyBtn.textContent = 'API í‚¤ ì €ì¥';
            saveApiKeyBtn.classList.remove('btn-danger');
            saveApiKeyBtn.classList.add('btn-primary');
            addRecordBtn.setAttribute('disabled', 'true');
            currentStockData = null;
            stockDataDisplay.textContent = '';
        } else {
            // í‚¤ ì €ì¥
            const inputKey = apiKeyInput.value.trim();
            if (inputKey) {
                apiKey = inputKey;
                localStorage.setItem(API_KEY_KEY, apiKey);
                loadApiKey(); // ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë‹¤ì‹œ ë¡œë“œ
            } else {
                alertUser("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');
            }
        }
    }

    function loadRecords() {
        const storedRecords = localStorage.getItem(RECORDS_KEY);
        if (storedRecords) {
            try {
                records = JSON.parse(storedRecords);
            } catch (e) {
                console.error("Failed to parse stored records:", e);
                records = [];
                localStorage.removeItem(RECORDS_KEY);
            }
        }
    }

    function saveRecords() {
        localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
        renderTable();
    }

    function alertUser(message, type = 'info') {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden', 'text-red-500', 'text-green-500');
        if (type === 'error') {
            errorMessage.classList.add('text-red-500');
        } else if (type === 'success') {
            errorMessage.classList.add('text-green-500');
        }
        setTimeout(() => errorMessage.classList.add('hidden'), 5000);
    }

    // --- 2. Gemini API í†µì‹  (ì£¼ê°€ ê°€ì ¸ì˜¤ê¸°) ---
    
    // Exponential backoffì„ í¬í•¨í•œ fetch í•¨ìˆ˜
    async function retryFetch(url, options, retries = 3) {
        let lastError = null;
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);

                // 400, 403 ì—ëŸ¬ëŠ” ì¬ì‹œë„í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ì¦‰ì‹œ ì—ëŸ¬ ë°œìƒì‹œí‚¤ê³  ì‘ë‹µ ë³¸ë¬¸ í¬í•¨
                if (response.status === 400 || response.status === 403) {
                    const errorBody = await response.text(); 
                    // ì—ëŸ¬ ë©”ì‹œì§€ê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ 300ìê¹Œì§€ë§Œ í‘œì‹œ
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}. ìƒì„¸: ${errorBody.substring(0, 300)}`);
                }
                
                if (response.ok) {
                    return response;
                }
                
                // 429 (Too Many Requests) ë˜ëŠ” 5xx ì˜¤ë¥˜ëŠ” ì¬ì‹œë„
                console.warn(`API ìš”ì²­ ì¬ì‹œë„ (${i + 1}/${retries}). ìƒíƒœ ì½”ë“œ: ${response.status}`);
            } catch (error) {
                console.error(`Fetch ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                lastError = error;
                if (i === retries - 1) throw lastError; // ë§ˆì§€ë§‰ ì‹œë„ëŠ” ì—ëŸ¬ ì¬ë°œìƒ
            }

            // Exponential backoff (1s, 2s, 4s, ...)
            const delay = Math.pow(2, i) * 1000 + Math.floor(Math.random() * 500);
            await new Promise(resolve => setTimeout(resolve, delay));
        }
        throw new Error("API ìš”ì²­ì´ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í•˜ì—¬ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }

    async function fetchStockData() {
        if (!apiKey) {
            alertUser("Gemini API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.", 'error');
            return;
        }

        const symbols = stockSymbolsInput.value.trim().split(',').map(s => s.trim()).filter(s => s.length > 0);
        if (symbols.length === 0) {
            alertUser("ê²€ìƒ‰í•  ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');
            return;
        }
        
        // [MODIFIED] ë‚ ì§œ ì…ë ¥ í•„ë“œì—ì„œ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const targetDate = recordDateInput.value; 
        if (!targetDate) {
            alertUser("ê¸°ë¡í•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
            return;
        }

        // UI ìƒíƒœ ì—…ë°ì´íŠ¸
        loadingSpinner.classList.remove('hidden');
        fetchBtnText.textContent = 'ì£¼ê°€ ê²€ìƒ‰ ì¤‘...';
        addRecordBtn.setAttribute('disabled', 'true');
        stockDataDisplay.textContent = '';
        currentStockData = null;
        errorMessage.classList.add('hidden');
        
        // [MODIFIED] ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: ì§€ì •ëœ ë‚ ì§œë¥¼ í¬í•¨í•˜ë„ë¡ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        const systemPrompt = `ë‹¹ì‹ ì€ ê¸ˆìœµ ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤. ìš”ì²­ëœ ì§€ìˆ˜ì™€ ì¢…ëª©ì˜ ${targetDate} ë‚ ì§œì˜ ê³µì‹ ì¢…ê°€ë¥¼ KOSPI, KOSDAQ, ê·¸ë¦¬ê³  ìš”ì²­ëœ ì¢…ëª© ì½”ë“œë³„ë¡œ ì •í™•í•˜ê²Œ ì°¾ìœ¼ì„¸ìš”. ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ í•´ë‹¹ ë‚ ì§œê°€ íœ´ì¥ì¼ì´ë©´ nullì„ ì‚¬ìš©í•˜ì„¸ìš”. ì¢…ê°€ëŠ” 15:30 KST ê¸°ì¤€ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ë‹¤ìŒ JSON êµ¬ì¡°ì— ë§ëŠ” ë°ì´í„°ë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
{
  "date": "[YYYY-MM-DD]",
  "KOSPI": [number],
  "KOSDAQ": [number],
  "stocks": [
    { "symbol": "[string]", "price": [number] }
  ]
}`;
        // [MODIFIED] ì‚¬ìš©ì ì¿¼ë¦¬: ì§€ì •ëœ ë‚ ì§œë¥¼ í¬í•¨í•˜ë„ë¡ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        const userQuery = `${targetDate} ë‚ ì§œì˜ KOSPI ì¢…ê°€, KOSDAQ ì¢…ê°€, ê·¸ë¦¬ê³  ë‹¤ìŒ ì¢…ëª©ë“¤ì˜ ì¢…ê°€ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”: ${symbols.join(', ')}. ì‘ë‹µì€ JSONë§Œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }], // Google Search Grounding í™œì„±í™” (ìœ ì§€)
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        const apiUrl = `${API_URL_BASE}${MODEL_NAME}:generateContent?key=${apiKey}`;

        // ì§€ìˆ˜ ë° ì¢…ëª© ì½”ë“œë¥¼ JSON ì‘ë‹µì— ë§ê²Œ ì •ë ¬í•˜ê¸° ìœ„í•´ ë§µ ìƒì„±
        const stockMap = symbols.reduce((acc, symbol) => {
            acc[symbol] = null; // ì´ˆê¸°ê°’ ì„¤ì •
            return acc;
        }, {});


        try {
            const response = await retryFetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!jsonText) {
                console.error("API ì‘ë‹µ ë‚´ìš©:", result);
                throw new Error("API ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSON ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì‘ë‹µ ë‚´ìš© ì½˜ì†” í™•ì¸)");
            }

            // JSON ë§ˆí¬ë‹¤ìš´ íœìŠ¤ ì œê±° ë¡œì§
            if (jsonText.startsWith("```json")) {
                jsonText = jsonText.substring(7, jsonText.lastIndexOf("```")).trim();
            } else if (jsonText.startsWith("```")) {
                jsonText = jsonText.substring(3, jsonText.lastIndexOf("```")).trim();
            }
            
            const data = JSON.parse(jsonText);

            // ë°ì´í„° êµ¬ì¡° í™•ì¸ ë° ê°€ê³µ
            const processedStocks = data.stocks.reduce((acc, stock) => {
                if (stock.symbol && stock.price !== undefined) {
                    acc[stock.symbol] = stock.price;
                }
                return acc;
            }, {});

            // ìµœì¢… ë°ì´í„° ê°ì²´ ìƒì„±
            currentStockData = {
                // APIì—ì„œ ë°˜í™˜ëœ dateë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                date: data.date, 
                KOSPI: data.KOSPI,
                KOSDAQ: data.KOSDAQ,
                stocks: {...stockMap, ...processedStocks} // ìš”ì²­í•œ ëª¨ë“  ì¢…ëª© í¬í•¨
            };

            displayStockData(currentStockData, symbols);
            addRecordBtn.removeAttribute('disabled');
            alertUser(`ì£¼ê°€ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. (ë‚ ì§œ: ${currentStockData.date})`, 'success');

        } catch (error) {
            // ìƒì„¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            console.error("Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", error);
            alertUser(`ì£¼ê°€ ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}. API í‚¤ë‚˜ ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.`, 'error');
            currentStockData = null; // ì‹¤íŒ¨ ì‹œ ë°ì´í„° ì´ˆê¸°í™”
        } finally {
            loadingSpinner.classList.add('hidden');
            fetchBtnText.textContent = 'ğŸ—“ï¸ ì£¼ê°€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Gemini API)';
        }
    }

    function displayStockData(data, symbols) {
        let html = `<strong>ë‚ ì§œ:</strong> ${data.date} | <strong>KOSPI:</strong> ${formatNumber(data.KOSPI)} | <strong>KOSDAQ:</strong> ${formatNumber(data.KOSDAQ)}`;

        symbols.forEach(symbol => {
            const price = data.stocks[symbol];
            html += ` | <strong>${symbol}:</strong> ${formatNumber(price)}`;
        });
        
        stockDataDisplay.innerHTML = html;
    }

    function formatNumber(num) {
        if (num === null || num === undefined) return "N/A";
        // í° ìˆ«ìì˜ ê²½ìš° ì†Œìˆ˜ì  ì—†ì´ í‘œì‹œ
        if (num > 1000) {
             return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 0 }).format(num);
        }
        return new Intl.NumberFormat('ko-KR').format(num);
    }

    // --- 3. ê¸°ë¡ ê´€ë¦¬ ë° ë Œë”ë§ ---

    function addRecord() {
        if (!currentStockData) {
            alertUser("ë¨¼ì € 'ì£¼ê°€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°'ë¥¼ í†µí•´ ì£¼ê°€ ë°ì´í„°ë¥¼ ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.", 'error');
            return;
        }

        const newRecord = {
            id: Date.now(),
            date: currentStockData.date, // APIì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ë‚ ì§œë¥¼ ì‚¬ìš©
            KOSPI: currentStockData.KOSPI,
            KOSDAQ: currentStockData.KOSDAQ,
            stocks: currentStockData.stocks, // ì¢…ëª© ì½”ë“œì™€ ê°€ê²©ì´ í¬í•¨ëœ ê°ì²´
            memo: memoInput.value.trim()
        };

        // [MODIFIED] ê¸°ì¡´ ê¸°ë¡ ë®ì–´ì“°ê¸° ë¡œì§: APIì—ì„œ ë°˜í™˜ëœ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
        const existingIndex = records.findIndex(r => r.date === newRecord.date);
        
        if (existingIndex !== -1) {
            // ê¸°ì¡´ ê¸°ë¡ ì‚­ì œ (ë®ì–´ì“°ê¸°)
            records.splice(existingIndex, 1); 
            alertUser(`ì´ë¯¸ ${newRecord.date} ë‚ ì§œì˜ ê¸°ë¡ì´ ì¡´ì¬í•˜ì—¬ ë®ì–´ì¼ìŠµë‹ˆë‹¤.`, 'info');
        }
        
        records.unshift(newRecord); // ê°€ì¥ ìµœê·¼ ê¸°ë¡ì„ ë§¨ ì•ì— ì¶”ê°€
        saveRecords();

        // ì…ë ¥ ìƒíƒœ ì´ˆê¸°í™”
        memoInput.value = '';
        currentStockData = null;
        stockDataDisplay.textContent = '';
        addRecordBtn.setAttribute('disabled', 'true');
        alertUser("ìƒˆ íˆ¬ì ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
    }

    function deleteRecord(id) {
        records = records.filter(record => record.id !== id);
        saveRecords();
        alertUser("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", 'info');
    }

    function getStockSymbolsFromRecords(records) {
        const allSymbols = new Set();
        records.forEach(record => {
            Object.keys(record.stocks || {}).forEach(symbol => allSymbols.add(symbol));
        });
        return Array.from(allSymbols).sort();
    }

    function renderTable() {
        // í…Œì´ë¸” í—¤ë” ì—…ë°ì´íŠ¸
        const symbols = getStockSymbolsFromRecords(records);
        const headerRow = journalTable.querySelector('thead tr');
        
        // ê¸°ì¡´ í—¤ë” (ë‚ ì§œ, ì½”ìŠ¤í”¼, ì½”ìŠ¤ë‹¥, ë©”ëª¨, ì‚­ì œ) ì™¸ì˜ ì¢…ëª© í—¤ë”ë¥¼ ì œê±°
        Array.from(headerRow.children).forEach((th, index) => {
            // 'KOSDAQ' ë‹¤ìŒ ì»¬ëŸ¼ë¶€í„° 'ë©”ëª¨' ì»¬ëŸ¼ ì „ê¹Œì§€ì˜ ëª¨ë“  ë™ì  ì¢…ëª© í—¤ë”ë¥¼ ì œê±°
            if (index >= 3 && index < headerRow.children.length - 2) {
                th.remove();
            }
        });

        // ìƒˆë¡œìš´ ì¢…ëª© í—¤ë” ì¶”ê°€
        const memoHeader = headerRow.querySelector('th:nth-last-child(2)'); // 'ë©”ëª¨' í—¤ë”
        symbols.forEach(symbol => {
            const th = document.createElement('th');
            th.className = 'px-4 py-3 text-xs font-medium tracking-wider';
            th.textContent = symbol;
            headerRow.insertBefore(th, memoHeader); // 'ë©”ëª¨' ì•ì— ì‚½ì…
        });

        // 'ë‚ ì§œ' í—¤ë”ì™€ 'ì‚­ì œ' í—¤ë”ì˜ ë¼ìš´ë“œ ì½”ë„ˆ ì†ì„±ì„ ë‹¤ì‹œ ì„¤ì •
        headerRow.querySelector('th:first-child').classList.add('rounded-tl-lg');
        headerRow.querySelector('th:last-child').classList.add('rounded-tr-lg');


        // í…Œì´ë¸” ë³¸ë¬¸ ì—…ë°ì´íŠ¸
        journalBody.innerHTML = '';
        if (records.length === 0) {
            journalTable.classList.add('hidden');
            emptyMessage.classList.remove('hidden');
            return;
        }

        journalTable.classList.remove('hidden');
        emptyMessage.classList.add('hidden');

        records.forEach(record => {
            const row = journalBody.insertRow();
            row.className = 'hover:bg-gray-50 transition duration-150';

            // ë‚ ì§œ
            let cell = row.insertCell();
            cell.textContent = record.date;
            
            // KOSPI
            cell = row.insertCell();
            cell.textContent = formatNumber(record.KOSPI);

            // KOSDAQ
            cell = row.insertCell();
            cell.textContent = formatNumber(record.KOSDAQ);

            // ë™ì  ì¢…ëª© ë°ì´í„°
            symbols.forEach(symbol => {
                cell = row.insertCell();
                const price = record.stocks?.[symbol];
                cell.textContent = price !== undefined ? formatNumber(price) : 'N/A';
            });

            // ë©”ëª¨
            cell = row.insertCell();
            cell.textContent = record.memo;
            cell.className = 'text-sm whitespace-pre-wrap max-w-xs';

            // ì‚­ì œ ë²„íŠ¼
            cell = row.insertCell();
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-danger p-1 rounded-md text-xs';
            deleteBtn.textContent = 'ì‚­ì œ';
            deleteBtn.onclick = () => deleteRecord(record.id);
            cell.appendChild(deleteBtn);
        });
    }

    // --- 4. CSV ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ---

    function downloadCsv() {
        if (records.length === 0) {
            alertUser("ë‹¤ìš´ë¡œë“œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.", 'info');
            return;
        }

        const symbols = getStockSymbolsFromRecords(records);
        
        // 1. í—¤ë” ìƒì„±
        let csvContent = "ë‚ ì§œ,KOSPI ì¢…ê°€,KOSDAQ ì¢…ê°€,";
        csvContent += symbols.map(s => `${s} ì¢…ê°€`).join(',') + ",ë©”ëª¨\n";

        // 2. ë°ì´í„° í–‰ ìƒì„±
        records.forEach(record => {
            let row = `${record.date},${record.KOSPI},${record.KOSDAQ},`;
            
            // ì¢…ëª© ë°ì´í„°
            const stockPrices = symbols.map(symbol => {
                const price = record.stocks?.[symbol];
                return price !== undefined && price !== null ? price : '';
            }).join(',');
            
            row += stockPrices;
            
            // ë©”ëª¨ (ì‰¼í‘œê°€ í¬í•¨ë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
            const escapedMemo = `"${record.memo.replace(/"/g, '""')}"`;
            row += `,${escapedMemo}\n`;
            
            csvContent += row;
        });

        // 3. BOM (Byte Order Mark) ì¶”ê°€ - ì—‘ì…€ì—ì„œ í•œê¸€ ê¹¨ì§ ë°©ì§€
        const BOM = "\uFEFF";
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
        
        // 4. ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­
        const filename = `íˆ¬ìì¼ì§€_ê¸°ë¡_${new Date().toISOString().slice(0, 10)}.csv`;
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alertUser("CSV ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
        } else {
            alertUser("ë¸Œë¼ìš°ì €ê°€ ë‹¤ìš´ë¡œë“œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì½˜ì†”ì—ì„œ ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.", 'error');
            console.log(csvContent);
        }
    }

    // ë¡œì»¬ ì €ì¥ì†Œ í™•ì¸ ë° ì´ˆê¸° ì•ˆë‚´
    if (typeof localStorage === 'undefined') {
        alertUser("ê²½ê³ : ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë¡ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", 'error');
    }
</script>

</body>
</html>
