<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ìì¼ì§€</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f8; /* ì•„ì£¼ ì—°í•œ íŒŒìŠ¤í…” ë¼ë²¤ë” ë°°ê²½ */
            color: #333;
        }
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” (ì„ íƒ ì‚¬í•­) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #b1a0c8; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f7f3f8; }

        /* API ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #8e6c8f;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* í…Œì´ë¸” í—¤ë” ë° í–‰ ìŠ¤íƒ€ì¼ */
        .journal-table th {
            background-color: #c7b3d1; /* íŒŒìŠ¤í…” ë³´ë¼ìƒ‰ í—¤ë” */
            color: white;
            padding: 12px 16px;
        }

        .journal-table td {
            padding: 12px 16px;
        }

        .journal-table tr:nth-child(even) {
            background-color: #fce8f4; /* ì§ìˆ˜ í–‰ ì—°í•œ í•‘í¬ */
        }

        .journal-table tr:nth-child(odd) {
            background-color: #ffffff; /* í™€ìˆ˜ í–‰ í°ìƒ‰ */
        }

        .journal-table tr:hover {
            background-color: #e5d7ec; /* í˜¸ë²„ ì‹œ ì—°í•œ ë¼ë²¤ë” */
        }

        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[type="text"], input[type="date"], textarea {
            border: 1px solid #d1c4e9;
            padding: 8px;
            border-radius: 8px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="date"]:focus, textarea:focus {
            border-color: #8e6c8f;
            outline: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-6xl mx-auto bg-white p-6 md:p-10 shadow-xl rounded-2xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-[#8e6c8f] border-b-4 border-[#c7b3d1] pb-2 inline-block">
                ğŸ“ˆ íˆ¬ìì¼ì§€
            </h1>
            <p class="text-md text-gray-500 mt-2">ë‚˜ë§Œì˜ íˆ¬ì ê¸°ë¡ì„ ë§¤ì¼ ì •ë¦¬í•˜ê³  ì €ì¥í•˜ì„¸ìš”.</p>
        </header>

        <!-- API í‚¤ ì„¤ì • ì˜ì—­ -->
        <section class="mb-8 p-4 bg-purple-50 rounded-xl shadow-inner">
            <h2 class="text-2xl font-semibold mb-3 text-[#8e6c8f]">ğŸ”‘ Gemini API í‚¤ ì„¤ì •</h2>
            <div class="flex flex-col md:flex-row gap-3">
                <input type="text" id="api-key-input" placeholder="ì—¬ê¸°ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                       class="flex-grow p-2 rounded-lg border border-purple-200 focus:ring-purple-400 focus:border-purple-400 transition">
                <button id="save-api-key"
                        class="bg-[#a591b9] text-white px-6 py-2 rounded-lg font-medium hover:bg-[#8e6c8f] transition shadow-md">
                    ì €ì¥
                </button>
            </div>
            <p id="api-key-status" class="mt-2 text-sm text-purple-600">API í‚¤ê°€ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
        </section>

        <!-- ì¼ì§€ ì¶”ê°€ ì˜ì—­ -->
        <section class="mb-10 p-6 bg-pink-50 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-[#8e6c8f]">ğŸ“ ìƒˆë¡œìš´ ê¸°ë¡ ì¶”ê°€</h2>

            <!-- ë‚ ì§œ ë° ì¢…ëª© ì„¤ì • -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- ë‚ ì§œ ì„ íƒ ê¸°ëŠ¥ ì¶”ê°€ -->
                <div>
                    <label for="record-date" class="block text-sm font-medium text-gray-700 mb-1">
                        ê¸°ë¡ ë‚ ì§œ ì„ íƒ
                    </label>
                    <input type="date" id="record-date"
                           class="w-full p-2 rounded-lg border border-pink-200 focus:ring-pink-400 focus:border-pink-400 transition">
                </div>
                
                <div>
                    <label for="stock-symbols" class="block text-sm font-medium text-gray-700 mb-1">
                        ì¢…ëª© ì„¤ì • (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: 005930.KS, TSLA, AAPL)
                    </label>
                    <input type="text" id="stock-symbols" value="005930.KS, 000660.KS, 035420.KS, 005380.KS, 000270.KS"
                           placeholder="ì—¬ê¸°ì— ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (5~15ê°œ ê¶Œì¥)"
                           class="w-full p-2 rounded-lg border border-pink-200 focus:ring-pink-400 focus:border-pink-400 transition">
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-3 mb-4">
                <button id="fetch-data"
                        class="flex-grow flex items-center justify-center bg-[#f0a5b8] text-white px-6 py-3 rounded-lg font-bold hover:bg-[#e47e95] transition shadow-lg disabled:opacity-50"
                        disabled>
                    ì¢…ê°€ ê°€ì ¸ì˜¤ê¸°
                    <span id="loading-indicator" class="ml-2 hidden">
                        <div class="spinner"></div>
                    </span>
                </button>
            </div>

            <div id="fetched-data-display" class="bg-white p-4 rounded-lg border border-pink-200 hidden">
                <!-- Fetchëœ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
            </div>
            
            <div class="mt-4 text-sm text-gray-500 p-2 bg-gray-50 rounded-lg border border-gray-100">
                âš ï¸ **ë°ì´í„° ê¸°ì¤€ì¼**ì€ ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‚ ì§œì— ê°€ì¥ ê°€ê¹Œìš´ **ê°€ì¥ ìµœê·¼ ë§ˆê°ëœ ê±°ë˜ì¼ì˜ ì •í™•í•œ ì¢…ê°€**ë¥¼ ê¸°ë¡í•˜ê¸° ìœ„í•´ ê²€ìƒ‰ë©ë‹ˆë‹¤.
            </div>

            <!-- ë©”ëª¨ ì…ë ¥ ë° ê¸°ë¡ ì¶”ê°€ -->
            <div class="mt-4">
                <label for="memo" class="block text-sm font-medium text-gray-700 mb-1">ì˜¤ëŠ˜ì˜ íˆ¬ì ë©”ëª¨</label>
                <textarea id="memo" rows="3" placeholder="ì˜¤ëŠ˜ì˜ ì‹œì¥ ë¶„ì„, íˆ¬ì ê²°ì •, ê°ì • ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”."
                          class="w-full p-2 rounded-lg border border-pink-200 focus:ring-pink-400 focus:border-pink-400 transition"></textarea>
            </div>

            <button id="add-entry"
                    class="w-full mt-4 bg-[#8e6c8f] text-white px-6 py-3 rounded-lg font-bold hover:bg-[#a591b9] transition shadow-lg disabled:opacity-50"
                    disabled>
                ê¸°ë¡ ì¶”ê°€
            </button>

            <p id="message-box" class="mt-3 text-sm text-red-500"></p>
        </section>

        <!-- ê¸°ë¡ ëª©ë¡ ë° CSV ë‹¤ìš´ë¡œë“œ -->
        <section class="p-6 bg-white rounded-xl shadow-lg border border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-[#8e6c8f]">ğŸ“‘ íˆ¬ì ê¸°ë¡ ëª©ë¡</h2>
                <button id="export-csv"
                        class="bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600 transition shadow-md disabled:opacity-50"
                        disabled>
                    ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
            <div id="journal-list-container" class="overflow-x-auto">
                <table id="journal-table" class="journal-table w-full text-sm text-left rounded-lg overflow-hidden">
                    <thead>
                        <!-- í—¤ë”ëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </thead>
                    <tbody>
                        <!-- ë°ì´í„°ëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </tbody>
                </table>
                <p id="no-data-message" class="text-center text-gray-500 p-4">ì•„ì§ ê¸°ë¡ëœ ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </section>

    </div>

    <script>
        // ì „ì—­ ìƒìˆ˜ ë° ë³€ìˆ˜ ì„¤ì •
        const API_MODEL = "gemini-2.5-flash-preview-05-20";
        const API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/";
        const JOURNAL_STORAGE_KEY = 'investmentJournal';
        const API_KEY_STORAGE_KEY = 'geminiApiKey';
        const STOCK_SYMBOLS_STORAGE_KEY = 'investmentStockSymbols'; 
        const MAX_RETRIES = 8; // API ì„œë²„ ê³¼ë¶€í•˜ ì˜¤ë¥˜(503)ì— ë” ì˜ ëŒ€ì‘í•˜ê¸° ìœ„í•´ ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ëŠ˜ë¦¼

        // UI ìš”ì†Œ
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key');
        const apiKeyStatus = document.getElementById('api-key-status');
        const recordDateInput = document.getElementById('record-date');
        const stockSymbolsInput = document.getElementById('stock-symbols');
        const fetchDataBtn = document.getElementById('fetch-data');
        const loadingIndicator = document.getElementById('loading-indicator');
        const fetchedDataDisplay = document.getElementById('fetched-data-display');
        const memoInput = document.getElementById('memo');
        const addEntryBtn = document.getElementById('add-entry');
        const exportCsvBtn = document.getElementById('export-csv');
        const journalTable = document.getElementById('journal-table');
        const messageBox = document.getElementById('message-box');
        const noDataMessage = document.getElementById('no-data-message');

        let journalData = [];
        let currentFetchedData = null; // APIì—ì„œ ê°€ì ¸ì˜¨ ì„ì‹œ ë°ì´í„° ì €ì¥

        // --- í—¬í¼ í•¨ìˆ˜ ---

        // í˜„ì¬ ì‹œê° ê°€ì ¸ì˜¤ê¸° (í´ë¼ì´ì–¸íŠ¸ ì‹œê°„)
        function getCurrentDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const date = now.toLocaleDateString('ko-KR', dateOptions);
            const time = now.toLocaleTimeString('ko-KR', timeOptions);
            return `${date} ${time}`;
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì¢…ëª© ì½”ë“œ ì €ì¥
        function saveStockSymbols() {
            const symbols = stockSymbolsInput.value.trim();
            if (symbols) {
                localStorage.setItem(STOCK_SYMBOLS_STORAGE_KEY, symbols);
            } else {
                localStorage.removeItem(STOCK_SYMBOLS_STORAGE_KEY);
            }
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¢…ëª© ì½”ë“œ ë¡œë“œ
        function loadStockSymbols() {
            const storedSymbols = localStorage.getItem(STOCK_SYMBOLS_STORAGE_KEY);
            if (storedSymbols) {
                stockSymbolsInput.value = storedSymbols;
            }
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— API í‚¤ ì €ì¥
        function saveApiKey() {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
                apiKeyStatus.textContent = "âœ… API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
                apiKeyStatus.classList.replace('text-red-500', 'text-purple-600');
                fetchDataBtn.disabled = false;
            } else {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
                apiKeyStatus.textContent = "âŒ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                apiKeyStatus.classList.replace('text-purple-600', 'text-red-500');
                fetchDataBtn.disabled = true;
            }
            saveStockSymbols(); 
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ API í‚¤ ë¡œë“œ
        function loadApiKey() {
            const apiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (apiKey) {
                apiKeyInput.value = apiKey;
                apiKeyStatus.textContent = "âœ… ì €ì¥ëœ API í‚¤ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.";
                apiKeyStatus.classList.replace('text-red-500', 'text-purple-600');
                fetchDataBtn.disabled = false;
            } else {
                apiKeyStatus.textContent = "âš ï¸ API í‚¤ë¥¼ ì…ë ¥ í›„ ì €ì¥í•˜ì—¬ ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ì„¸ìš”.";
                apiKeyStatus.classList.replace('text-purple-600', 'text-red-500');
                fetchDataBtn.disabled = true;
            }
            
            // ë‚ ì§œ ì…ë ¥ í•„ë“œì˜ ê¸°ë³¸ê°’ì„ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
            const today = new Date().toISOString().slice(0, 10);
            recordDateInput.value = today;
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¼ì§€ ë°ì´í„° ë¡œë“œ
        function loadJournalData() {
            const storedData = localStorage.getItem(JOURNAL_STORAGE_KEY);
            if (storedData) {
                try {
                    journalData = JSON.parse(storedData);
                    // ë°ì´í„° ë¡œë“œ ì‹œ ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬ (ê°€ì¥ ì˜¤ë˜ëœ ê¸°ë¡ì´ ìœ„ë¡œ)
                    journalData.sort((a, b) => new Date(a.date) - new Date(b.date));
                } catch (e) {
                    console.error("Error parsing journal data from localStorage:", e);
                    journalData = [];
                }
            } else {
                journalData = [];
            }
            renderJournalTable();
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì¼ì§€ ë°ì´í„° ì €ì¥
        function saveJournalData() {
            localStorage.setItem(JOURNAL_STORAGE_KEY, JSON.stringify(journalData));
            renderJournalTable();
        }

        // ë©”ì‹œì§€ ë°•ìŠ¤ í‘œì‹œ
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.classList.remove('text-red-500', 'text-green-500');
            messageBox.classList.add(isError ? 'text-red-500' : 'text-green-500');
        }

        // ì§€ìˆ˜ ë° ì£¼ì‹ ì¢…ê°€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (Gemini API)
        async function fetchStockData() {
            const apiKey = apiKeyInput.value.trim();
            const symbols = stockSymbolsInput.value.trim();
            const selectedDate = recordDateInput.value;

            if (!apiKey || !symbols || !selectedDate) {
                showMessage("API í‚¤, ì¢…ëª© ì½”ë“œ, ê·¸ë¦¬ê³  ê¸°ë¡ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥/ì„ íƒí•´ì£¼ì„¸ìš”.", true);
                return;
            }

            saveStockSymbols();

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸
            fetchDataBtn.disabled = true;
            addEntryBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');
            showMessage("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...", false);
            fetchedDataDisplay.classList.add('hidden');

            const API_URL = `${API_URL_BASE}${API_MODEL}:generateContent?key=${apiKey}`;
            
            const systemPrompt = `
                ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ê¸ˆìœµ ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤.
                ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ **ë°˜ë“œì‹œ ë‹¤ìŒ JSON ìŠ¤í‚¤ë§ˆë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ë‹µí•˜ì‹­ì‹œì˜¤.**
                ì‘ë‹µì€ **JSON ë¬¸ìì—´ ê·¸ ìì²´**ì—¬ì•¼ í•˜ë©°, ì–´ë– í•œ ì„¤ëª…, ì„œë¡ , ê²°ë¡ , ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(\`\`\`json)ë„ í¬í•¨í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
                ëª¨ë“  ê°€ê²©ì€ ìˆ«ì(ì •ìˆ˜ ë˜ëŠ” ì†Œìˆ˜ì  ë‘ ìë¦¬ê¹Œì§€) í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
                
                JSON ë°ì´í„° êµ¬ì¡° ì˜ˆì‹œ:
                {
                    "date": "2025-05-15",
                    "KOSPI": 2700.50,
                    "KOSDAQ": 850.25,
                    "stocks": [
                        {"symbol": "005930.KS", "name": "ì‚¼ì„±ì „ì", "price": 80000},
                        {"symbol": "AAPL", "name": "Apple Inc.", "price": 195.50},
                        ...
                    ]
                }
            `;

            const userQuery = `
                **[ìµœëŒ€ ê°•ë„]** ì›¹ ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒ ì¡°ê±´ì„ ì¶©ì¡±í•˜ëŠ” ì¢…ê°€ ë°ì´í„°ë¥¼ ì°¾ìœ¼ì‹­ì‹œì˜¤:
                1. ë°ì´í„° ê¸°ì¤€ì¼ì€ ${selectedDate}ì— ê°€ì¥ ê°€ê¹ê³ , ì´ ë‚ ì§œë¥¼ ì´ˆê³¼í•˜ì§€ ì•ŠëŠ” ê°€ì¥ ìµœê·¼ ê±°ë˜ì¼ì˜ ì¢…ê°€ ë°ì´í„°ì—¬ì•¼ í•©ë‹ˆë‹¤. (ì„ íƒí•œ ë‚ ì§œ ì´ì „/ë‹¹ì¼ ì¤‘ ê°€ì¥ ìµœê·¼ ë§ˆê°ì¼)
                2. ë°ì´í„°ì˜ ê¸°ì¤€ ì‹œì ì€ í•œêµ­ ì‹œì¥ ë§ˆê° ì‹œê°„ì¸ 15:30 KSTë¥¼ ì¶©ì¡±í•´ì•¼ í•©ë‹ˆë‹¤.
                3. **ê° ì¢…ëª©ì— ëŒ€í•´ ì¢…ëª©ëª…(íšŒì‚¬ ì´ë¦„)ì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì‹­ì‹œì˜¤.**
                ê²€ìƒ‰ ëŒ€ìƒ ì§€ìˆ˜ ë° ì£¼ì‹ ì¢…ëª© ì½”ë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„): KOSPI, KOSDAQ, ${symbols}
            `;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText} (Response: ${errorBody.substring(0, 100)}...)`);
                    }

                    const result = await response.json();
                    
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        throw new Error("API ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSON í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
                    }

                    let fetchedJson;
                    try {
                        fetchedJson = JSON.parse(jsonText);
                    } catch (e) {
                        console.error("JSON Parsing Error:", e);
                        throw new Error("ëª¨ë¸ì´ ìœ íš¨í•œ JSON í˜•ì‹ì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª¨ë¸ì´ ì„¤ëª… í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤: " + jsonText.substring(0, 50));
                    }


                    currentFetchedData = fetchedJson;
                    
                    const clientDateTime = getCurrentDateTime();

                    // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
                    renderFetchedData(fetchedJson, clientDateTime);
                    showMessage(`âœ… ${fetchedJson.date} ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì„±ê³µ! (ê°€ì¥ ìµœê·¼ ë§ˆê°ì¼ ê¸°ì¤€)`, false);
                    addEntryBtn.disabled = false;
                    return; // ì„±ê³µ ì‹œ ë£¨í”„ ì¢…ë£Œ

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error.message);
                    if (i === MAX_RETRIES - 1) {
                        showMessage(`âŒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}. API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜, ë‚ ì§œë¥¼ ë‹¤ì‹œ ì„ íƒí•˜ê±°ë‚˜, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`, true);
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }

            // ëª¨ë“  ì‹œë„ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ UI ë³µêµ¬
            fetchDataBtn.disabled = false;
            loadingIndicator.classList.add('hidden');
            currentFetchedData = null;
        }

        // ê°€ì ¸ì˜¨ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function renderFetchedData(data, clientTime) {
            const stocksHtml = data.stocks.map(stock => 
                `<span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded-full mr-2 mb-1"
                      title="${stock.symbol}">
                    ${stock.name} (${stock.symbol}): ${formatPrice(stock.price)}
                </span>`
            ).join('');

            fetchedDataDisplay.innerHTML = `
                <p class="text-sm text-gray-500 mb-1">ğŸ“… ì¡°íšŒ ì‹œê°: ${clientTime}</p>
                <p class="font-bold text-lg text-[#8e6c8f] mb-2">ğŸ“Š ë°ì´í„° ê¸°ì¤€ì¼: ${data.date} (ê°€ì¥ ìµœê·¼ ë§ˆê°ì¼)</p>
                <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                    <p><strong>KOSPI:</strong> ${formatPrice(data.KOSPI)}</p>
                    <p><strong>KOSDAQ:</strong> ${formatPrice(data.KOSDAQ)}</p>
                </div>
                <p class="font-semibold text-gray-700 mb-1">ê°œë³„ ì¢…ëª© ì¢…ê°€:</p>
                <div>${stocksHtml}</div>
            `;
            fetchedDataDisplay.classList.remove('hidden');
        }

        // ê°€ê²© í¬ë§·íŒ… í—¬í¼
        function formatPrice(price) {
            if (typeof price === 'number') {
                return price.toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            }
            return price;
        }

        // ìƒˆë¡œìš´ ê¸°ë¡ ì¶”ê°€
        function addJournalEntry() {
            if (!currentFetchedData) {
                showMessage("ë¨¼ì € 'ì¢…ê°€ ê°€ì ¸ì˜¤ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.", true);
                return;
            }

            const memo = memoInput.value.trim() || 'ë©”ëª¨ ì—†ìŒ';
            const newEntry = {
                id: Date.now(),
                ...currentFetchedData,
                memo: memo
            };

            // ì´ë¯¸ ê°™ì€ ë‚ ì§œì˜ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            const isDuplicate = journalData.some(entry => entry.date === newEntry.date);
            if (isDuplicate) {
                showMessage(`âŒ ${newEntry.date} ë‚ ì§œì˜ ê¸°ë¡ì€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`, true);
                return;
            }

            // [ìˆ˜ì •] ìµœì‹  ë°ì´í„°ë¥¼ ë§¨ ë’¤ì— ì¶”ê°€ (ì˜¤ë˜ëœ ìˆœì„œëŒ€ë¡œ í‘œì‹œ)
            journalData.push(newEntry); 
            // ë°°ì—´ì— ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ ì •ë ¬
            journalData.sort((a, b) => new Date(a.date) - new Date(b.date));

            saveJournalData();
            
            // UI ì´ˆê¸°í™”
            memoInput.value = '';
            currentFetchedData = null;
            fetchedDataDisplay.classList.add('hidden');
            addEntryBtn.disabled = true;
            showMessage(`âœ… ${newEntry.date} ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, false);
        }
        
        // ë°ì´í„° í…Œì´ë¸” ë Œë”ë§
        function renderJournalTable() {
            const tableHead = journalTable.querySelector('thead');
            const tableBody = journalTable.querySelector('tbody');

            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
            if (journalData.length === 0) {
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                noDataMessage.classList.remove('hidden');
                exportCsvBtn.disabled = true;
                return;
            }

            noDataMessage.classList.add('hidden');
            exportCsvBtn.disabled = false;

            // 1. í—¤ë” ìƒì„± (ì²« ë²ˆì§¸ í•­ëª© ê¸°ì¤€ìœ¼ë¡œ)
            const firstEntry = journalData[0];
            let headers = ['ë‚ ì§œ', 'KOSPI', 'KOSDAQ'];
            
            // ë™ì  í—¤ë” ë° ì‹¬ë³¼ í‚¤ë¥¼ ì €ì¥í•  ë°°ì—´
            const dynamicDisplayHeaders = []; 
            const dynamicSymbolKeys = []; 

            // í—¤ë”ì— ì¢…ëª© ì´ë¦„ê³¼ ì½”ë“œë¥¼ í•¨ê»˜ í‘œì‹œ
            firstEntry.stocks.forEach(stock => {
                const headerText = `${stock.name} (${stock.symbol})`;
                dynamicDisplayHeaders.push(headerText);
                dynamicSymbolKeys.push(stock.symbol); // ë°ì´í„° ë£©ì—…ì„ ìœ„í•œ í‚¤ ì €ì¥
            });
            
            headers.push(...dynamicDisplayHeaders);
            headers.push('ë©”ëª¨ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)', 'ì‚­ì œ'); // ë©”ëª¨ í—¤ë” ì—…ë°ì´íŠ¸

            tableHead.innerHTML = `
                <tr>
                    ${headers.map(h => `<th scope="col" class="py-3 px-6 text-xs font-semibold uppercase tracking-wider">${h}</th>`).join('')}
                </tr>
            `;

            // 2. ë°”ë”” ìƒì„±
            tableBody.innerHTML = journalData.map(entry => {
                // HTML ì—”í‹°í‹° ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
                const escapeHtml = (unsafe) => {
                    if (!unsafe) return '';
                    return unsafe.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                };

                let row = [
                    `<td class="font-medium text-gray-900 whitespace-nowrap">${entry.date}</td>`,
                    `<td>${formatPrice(entry.KOSPI)}</td>`,
                    `<td>${formatPrice(entry.KOSDAQ)}</td>`
                ];

                // í˜„ì¬ ì—”íŠ¸ë¦¬ì˜ ì¢…ëª© ê°€ê²©ì„ ì‹¬ë³¼ë¡œ ì°¾ê¸° ì‰½ê²Œ Mapìœ¼ë¡œ ë³€í™˜
                const stockPricesMap = entry.stocks.reduce((map, stock) => {
                    map[stock.symbol] = stock.price;
                    return map;
                }, {});

                // dynamicSymbolKeys ìˆœì„œëŒ€ë¡œ ê°€ê²© ë°ì´í„°ë¥¼ ì‚½ì…
                dynamicSymbolKeys.forEach(symbol => {
                    // Symbol í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ê²©ì„ ì¡°íšŒ
                    const price = stockPricesMap[symbol] !== undefined ? formatPrice(stockPricesMap[symbol]) : '-';
                    row.push(`<td>${price}</td>`);
                });

                // [ìˆ˜ì •] ë©”ëª¨ë¥¼ í´ë¦­í•˜ì—¬ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” Span íƒœê·¸ë¡œ ë Œë”ë§
                row.push(`
                    <td data-id="${entry.id}">
                        <span id="memo-display-${entry.id}" 
                              onclick="startEditingMemo(${entry.id})" 
                              class="block cursor-pointer hover:bg-yellow-50 p-1 rounded-md max-w-xs break-words text-gray-700"
                              title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">
                            ${escapeHtml(entry.memo)}
                        </span>
                    </td>
                `);

                row.push(`<td>
                    <button onclick="deleteEntry(${entry.id})" 
                            class="text-red-500 hover:text-red-700 transition focus:outline-none">
                        âŒ
                    </button>
                </td>`);

                return `<tr>${row.join('')}</tr>`;
            }).join('');
        }

        // ê¸°ë¡ ì‚­ì œ
        window.deleteEntry = function(id) {
            journalData = journalData.filter(entry => entry.id !== id);
            saveJournalData();
            showMessage('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', false);
        }

        // [ì¶”ê°€] ë©”ëª¨ ìˆ˜ì • ì‹œì‘
        window.startEditingMemo = function(id) {
            const displayElement = document.getElementById(`memo-display-${id}`);
            if (!displayElement) return;

            const currentMemo = displayElement.textContent.trim();
            const parentCell = displayElement.parentElement;
            
            // 1. í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
            const textarea = document.createElement('textarea');
            textarea.id = `memo-input-${id}`;
            textarea.className = 'w-full p-1 border border-purple-400 rounded-md text-sm resize-none focus:ring-purple-500 focus:border-purple-500 shadow-inner';
            textarea.value = currentMemo;
            textarea.rows = Math.max(3, currentMemo.split('\n').length); // ë©”ëª¨ ê¸¸ì´ì— ë”°ë¼ ë†’ì´ ì¡°ì •
            textarea.setAttribute('data-original-memo', currentMemo); // Esc í‚¤ ë³µì›ì„ ìœ„í•´ ì›ë³¸ ì €ì¥

            // 2. ìˆ˜ì • ì™„ë£Œ (Blur ì´ë²¤íŠ¸: í¬ì»¤ìŠ¤ë¥¼ ìƒìœ¼ë©´ ì €ì¥)
            textarea.addEventListener('blur', () => {
                saveMemo(id, textarea);
            });
            
            // 3. Enter í‚¤ ì…ë ¥ ì‹œ ì €ì¥ (Shift+EnterëŠ” ì¤„ ë°”ê¿ˆ)
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    textarea.blur(); // blur ì´ë²¤íŠ¸ ë°œìƒì‹œì¼œ ì €ì¥ ë° ë·° ì „í™˜
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    // Esc ëˆ„ë¥´ë©´ ì›ë³¸ìœ¼ë¡œ ë³µì›
                    const originalMemo = textarea.getAttribute('data-original-memo');
                    const entryIndex = journalData.findIndex(entry => entry.id === id);
                    if (entryIndex !== -1) {
                        journalData[entryIndex].memo = originalMemo; // ì„ì‹œë¡œ ì›ë³¸ ë©”ëª¨ë¡œ ë³µì›
                    }
                    textarea.blur(); // blurë¥¼ í†µí•´ renderJournalTableì´ í˜¸ì¶œë˜ë„ë¡ í•¨
                }
            });

            // 4. êµì²´ ë° í¬ì»¤ìŠ¤
            parentCell.innerHTML = '';
            parentCell.appendChild(textarea);
            textarea.focus();
        }
        
        // [ì¶”ê°€] ë©”ëª¨ ì €ì¥ ë° ë·° ë³µì›
        function saveMemo(id, textareaElement) {
            const newMemo = textareaElement.value.trim() || 'ë©”ëª¨ ì—†ìŒ';
            const entryIndex = journalData.findIndex(entry => entry.id === id);

            if (entryIndex !== -1) {
                // ë‚´ìš©ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì €ì¥
                if (journalData[entryIndex].memo !== newMemo) {
                    journalData[entryIndex].memo = newMemo;
                    saveJournalData(); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ ë° í…Œì´ë¸” ë¦¬ë Œë”ë§
                    showMessage('âœ… ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', false);
                    return;
                }
            }

            // ë³€ê²½ ì‚¬í•­ì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ê²½ìš°:
            // renderJournalTable()ì„ í˜¸ì¶œí•˜ì—¬ ë©”ëª¨ë¥¼ ë‹¤ì‹œ <span> íƒœê·¸ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
            renderJournalTable();
            if (entryIndex === -1) {
                showMessage('âŒ ë©”ëª¨ë¥¼ ì €ì¥í•  ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);
            }
        }

        // CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        function exportToCSV() {
            if (journalData.length === 0) {
                showMessage("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", true);
                return;
            }

            // 1. í—¤ë” (CSVëŠ” ë¶„ì„ í¸ì˜ë¥¼ ìœ„í•´ ì¢…ëª© ì´ë¦„ê³¼ ì½”ë“œë¥¼ í•¨ê»˜ í—¤ë”ë¡œ ìœ ì§€í•©ë‹ˆë‹¤)
            const firstEntry = journalData[0];
            let headers = ['ë‚ ì§œ', 'KOSPI', 'KOSDAQ'];
            const symbolKeys = [];

            // ì¢…ëª© ì´ë¦„ê³¼ ì½”ë“œë¥¼ í•¨ê»˜ í—¤ë”ë¡œ ì‚¬ìš©
            firstEntry.stocks.forEach(stock => {
                headers.push(`${stock.name} (${stock.symbol})`);
                symbolKeys.push(stock.symbol);
            });
            headers.push('ë©”ëª¨');

            let csvContent = headers.join(',') + '\n';

            // 2. ë°ì´í„° í–‰
            journalData.forEach(entry => {
                const stockPrices = {};
                entry.stocks.forEach(stock => { stockPrices[stock.symbol] = stock.price; });

                let rowData = [
                    entry.date,
                    entry.KOSPI,
                    entry.KOSDAQ
                ];

                // SymbolKeys ìˆœì„œì— ë§ì¶° ê°€ê²© ë°ì´í„°ë¥¼ ì‚½ì…
                symbolKeys.forEach(symbol => { 
                    const price = stockPrices[symbol] !== undefined ? stockPrices[symbol] : '';
                    rowData.push(price);
                });

                // ë©”ëª¨ í•„ë“œëŠ” ì‰¼í‘œ ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ ë”°ì˜´í‘œë¡œ ê°ìŒˆ
                // ì¤„ ë°”ê¿ˆì€ ê³µë°±ìœ¼ë¡œ ëŒ€ì²´í•˜ê³ , ë”°ì˜´í‘œëŠ” ì´ì¤‘ ë”°ì˜´í‘œë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                rowData.push(`"${entry.memo.replace(/"/g, '""').replace(/\n/g, ' ')}"`);
                csvContent += rowData.join(',') + '\n';
            });

            // 3. íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM ì¶”ê°€í•˜ì—¬ í•œê¸€ ê¹¨ì§ ë°©ì§€
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `íˆ¬ìì¼ì§€_ê¸°ë¡_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage('âœ… ê¸°ë¡ì„ CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.', false);
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---

        // API í‚¤ ì €ì¥ ë²„íŠ¼ í´ë¦­
        saveApiKeyBtn.addEventListener('click', saveApiKey);

        // ì¢…ê°€ ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ í´ë¦­
        fetchDataBtn.addEventListener('click', fetchStockData);

        // ê¸°ë¡ ì¶”ê°€ ë²„íŠ¼ í´ë¦­
        addEntryBtn.addEventListener('click', addJournalEntry);

        // CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­
        exportCsvBtn.addEventListener('click', exportToCSV);
        
        // ì¢…ëª© ì„¤ì • ì…ë ¥ë€ì˜ ë‚´ìš©ì´ ë³€ê²½ë˜ê±°ë‚˜ í¬ì»¤ìŠ¤ë¥¼ ìƒìœ¼ë©´ ì¦‰ì‹œ ì €ì¥
        stockSymbolsInput.addEventListener('change', saveStockSymbols);

        // ì´ˆê¸° ë¡œë“œ
        window.onload = () => {
            loadApiKey();
            loadStockSymbols();
            loadJournalData();
        };

    </script>
</body>
</html>
